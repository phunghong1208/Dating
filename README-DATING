# HeartLink Microservices Architecture

Dá»± Ã¡n HeartLink Ä‘Æ°á»£c tÃ¡ch thÃ nh 3 microservices riÃªng biá»‡t, sá»­ dá»¥ng chung má»™t MongoDB database `bachasoft`.

## ğŸ—ï¸ Kiáº¿n trÃºc Microservices

### **1. App Service** (Port 3001)
- **Chá»©c nÄƒng**: Quáº£n lÃ½ user, authentication, matching, cards, swipe actions
- **Database**: `bachasoft` (chung)
- **Collections**: `users`, `profiles`, `cards`, `matches`, `images`, `static_data`
- **Endpoints chÃ­nh**:
  - Authentication: `/api/v1/login`, `/api/v1/register`, `/api/v1/refreshToken`
  - User Management: `/api/v1/profile`, `/api/v1/setting`
  - Cards/Matching: `/api/v1/cards`, `/api/v1/like`, `/api/v1/nope`
  - Image Management: `/api/v1/image/profile`
  - Static Data: `/api/v1/statics/*`

### **2. Chat Service** (Port 3002)
- **Chá»©c nÄƒng**: Quáº£n lÃ½ chat, messages, friends, channels
- **Database**: `bachasoft` (chung)
- **Collections**: `friends`, `channels`, `messages`, `conversations`
- **Endpoints chÃ­nh**:
  - Friends: `/api/v1/friends`, `/api/v1/friends/new`
  - Channels: `/api/v1/channels`, `/api/v1/getChannelId`
  - Messages: `/api/v1/channels/:chatId/messages`, `/api/v1/messages/add`

### **3. Admin Service** (Port 3003)
- **Chá»©c nÄƒng**: Quáº£n lÃ½ admin, reports, analytics, customer management
- **Database**: `bachasoft` (chung)
- **Collections**: `admins`, `customers`, `reports`, `activities`, `payments`, `static_data`
- **Endpoints chÃ­nh**:
  - Admin Auth: `/api/login`, `/api/logout`
  - User Management: `/api/users`, `/api/users-disabled`
  - Customer Management: `/api/customers`, `/api/card-customer-user`
  - Reports: `/api/reports`, `/api/list-report`
  - CRUD Operations: `/api/areas`, `/api/packages`, `/api/jobs`, etc.

## ğŸš€ CÃ¡ch cháº¡y

### **Option 1: Docker Compose (Khuyáº¿n nghá»‹)**

```bash
# Cháº¡y táº¥t cáº£ services
docker-compose up

# Cháº¡y á»Ÿ background
docker-compose up -d

# Dá»«ng services
docker-compose down
```

### **Option 2: Cháº¡y tá»«ng service riÃªng láº»**

```bash
# 1. Khá»Ÿi Ä‘á»™ng MongoDB
docker run -d --name mongodb -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=bachasoft \
  -e MONGO_INITDB_ROOT_PASSWORD=123654 \
  -e MONGO_INITDB_DATABASE=bachasoft \
  mongo:5.0

# 2. Táº¡o file .env cho App Service
cd app-service
cat > .env << EOF
NODE_ENV=dev
PORT=3001
DB_HOST=127.0.0.1
DB_PORT=27017
DB_NAME=bachasoft
DB_USER=bachasoft
DB_PASS=123654
EOF

npm install
npm start

# 3. Cháº¡y Chat Service (terminal má»›i)
cd ../chat-service
cat > .env << EOF
NODE_ENV=dev
PORT=3002
DB_HOST=127.0.0.1
DB_PORT=27017
DB_NAME=bachasoft
DB_USER=bachasoft
DB_PASS=123654
EOF

npm install
npm start

# 4. Cháº¡y Admin Service (terminal má»›i)
cd ../admin-service
cat > .env << EOF
NODE_ENV=dev
PORT=3003
DB_HOST=127.0.0.1
DB_PORT=27017
DB_NAME=bachasoft
DB_USER=bachasoft
DB_PASS=123654
EOF

npm install
npm start
```

## ğŸ“Š Kiá»ƒm tra services

### **Health Checks**
```bash
# App Service
curl http://localhost:3001/health

# Chat Service
curl http://localhost:3002/health

# Admin Service
curl http://localhost:3003/health
```

### **Test Endpoints**
```bash
# App Service - Get cards
curl http://localhost:3001/api/v1/cards

# Chat Service - Get friends
curl http://localhost:3002/api/v1/friends

# Admin Service - Get users
curl http://localhost:3003/api/users
```

## ğŸ—„ï¸ Database Structure

### **MongoDB Database: `bachasoft`**

#### **Collections chung:**
- `users` - ThÃ´ng tin user (App Service)
- `profiles` - Profile chi tiáº¿t (App Service)
- `cards` - Cards Ä‘á»ƒ swipe (App Service)
- `matches` - Káº¿t quáº£ matching (App Service)
- `images` - áº¢nh profile (App Service)
- `static_data` - Dá»¯ liá»‡u tÄ©nh (App Service)
- `friends` - Danh sÃ¡ch friends (Chat Service)
- `channels` - Chat channels (Chat Service)
- `messages` - Messages trong channels (Chat Service)
- `conversations` - Lá»‹ch sá»­ chat (Chat Service)
- `admins` - Admin users (Admin Service)
- `customers` - Customer data (Admin Service)
- `reports` - BÃ¡o cÃ¡o vi pháº¡m (Admin Service)
- `activities` - User activities (Admin Service)
- `payments` - Payment records (Admin Service)

## ğŸ”§ Environment Variables

### **Chung cho táº¥t cáº£ services:**
```env
NODE_ENV=dev
PORT=<port>
DB_HOST=127.0.0.1
DB_PORT=27017
DB_NAME=bachasoft
DB_USER=bachasoft
DB_PASS=123654
```

### **App Service:**
```env
PORT=3001
```

### **Chat Service:**
```env
PORT=3002
```

### **Admin Service:**
```env
PORT=3003
```

## ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

```
dating/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.js          # Config database chung
â”œâ”€â”€ app-service/
â”‚   â”œâ”€â”€ app.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ .env (táº¡o thá»§ cÃ´ng)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ app.js
â”‚   â”‚   â””â”€â”€ chat.js
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ chat-service/
â”‚   â”œâ”€â”€ app.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ .env (táº¡o thá»§ cÃ´ng)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ chat.js
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ admin-service/
â”‚   â”œâ”€â”€ app.js
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ .env (táº¡o thá»§ cÃ´ng)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ admin.js
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README-microservices.md
```

## ğŸ”„ Service Communication

### **Inter-Service Communication**
- **App Service** â†” **Chat Service**: Gá»i API Ä‘á»ƒ láº¥y thÃ´ng tin friends/matches
- **App Service** â†” **Admin Service**: Gá»i API Ä‘á»ƒ bÃ¡o cÃ¡o vi pháº¡m
- **Chat Service** â†” **App Service**: Gá»i API Ä‘á»ƒ láº¥y thÃ´ng tin user

### **Database Sharing**
- Cáº£ 3 services chia sáº» chung database `bachasoft`
- Má»—i service quáº£n lÃ½ collections riÃªng cá»§a mÃ¬nh
- CÃ³ thá»ƒ truy cáº­p cross-service data khi cáº§n

### **API Gateway (TÆ°Æ¡ng lai)**
CÃ³ thá»ƒ thÃªm API Gateway Ä‘á»ƒ:
- Rate limiting
- Authentication/Authorization
- Request routing
- Load balancing

## ğŸš€ Deployment

### **Development**
```bash
docker-compose up --build
```

### **Production**
```bash
# Build images
docker-compose build

# Run with production config
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

## ğŸ“ Notes

- âœ… Táº¥t cáº£ services sá»­ dá»¥ng chung MongoDB database `bachasoft`
- âœ… Config database chung á»Ÿ `config/database.js`
- âœ… Environment variables Ä‘Æ¡n giáº£n, chá»‰ cáº§n thiáº¿t
- âœ… Cáº¥u trÃºc thÆ° má»¥c Ä‘Æ¡n giáº£n (services á»Ÿ root level)
- âœ… Táº¥t cáº£ services hiá»‡n táº¡i Ä‘ang sá»­ dá»¥ng mock controllers
- âœ… Cáº§n implement thá»±c táº¿ cÃ¡c controllers vÃ  models
- âœ… CÃ³ thá»ƒ thÃªm authentication middleware
- âœ… CÃ³ thá»ƒ thÃªm logging vÃ  monitoring
- âœ… CÃ³ thá»ƒ thÃªm caching (Redis) cho performance 



cd app-service && npm install
cd chat-service && npm install  
cd admin-service && npm install

lsof -i :3001
kill -9 12345


mongodump --db bachasoft --out /tmp/backup_bachasoft
docker cp /tmp/backup_bachasoft heartlink-mongodb:/backup_bachasoft
docker exec -it heartlink-mongodb mongorestore -u bachasoft -p 123654 --authenticationDatabase bachasoft --db bachasoft /backup_bachasoft/bachasoft


docker exec -it heartlink-mongodb mongosh -u bachasoft -p 123654 --authenticationDatabase bachasoft
use bachasoft
show collections
db.channels.find().pretty()
db.friends.find().pretty()
db.messages.find().pretty()
db.conversations.find().pretty()
db.customers.find().pretty()
db.reports.find().pretty()
db.activities.find().pretty()
db.payments.find().pretty()
db.admins.find().pretty()
db.static_data.find().pretty()